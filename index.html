<!DOCTYPE html>
<html lang="en"> 
<head>
  <meta charset="utf-8" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  <link type="text/css" href="styles/styles.css" rel="stylesheet" />
  <link rel="shortcut icon" href="get/favicon.png" type="image/png" />
  <title>PLINAR</title>
  <noscript><div><img src="https://mc.yandex.ru/watch/38179485" style="position:absolute; left:-9999px;" alt="" /></div></noscript> 
</head> 
<body>
  <model-viewer id="color" class="model-viewer" bounds="tight" src="get/demo.glb" ios-src="get/demo.usdz" shadow-intensity="1" 
    ar enable-pan ar-scale="auto" camera-controls exposure="1" ar-modes="scene-viewer quick-look webxr" 
    quick-look-browsers="safari chrome" auto-rotate scale="1.2 1.2 1.2" min-camera-orbit="auto auto auto" 
    max-camera-orbit="auto auto auto" autoplay >
    <div class="progress-bar hide" slot="progress-bar"> 
      <div class="update-bar"></div> 
    </div>
    <button onclick="myFunction()" slot="ar-button" id="ar-button" class="ar-button"> Включить AR </button>
    <div id="ar-prompt"> <img src="get/hand.png" /></div>
  </model-viewer>
  <div class="frame">
    <button class="button__view-ar" id="ar">
        <span class="button__view-ar--span">
            <img src="assets/iconAR.png" class="button__view-ar--icon" alt="icon_ar">
        </span>
        <p class="button__view-ar--text">VIEW IN AR</p>
    </button>
    <div class="frame__select-colors">
      <div class="first">
        <select id="colors-main" class="box-select">
          <option value="" selected disabled hidden>Основной цвет:</option>
          <option value="red">Красный</option>
          <option value="green">Зеленый</option>
          <option value="blue">Синий</option>
        </select>
      </div>
      <div class="second">
        <select id="colors-second" class="box-select">
          <option value="" selected disabled hidden>Вспомогательный цвет:</option>
          <option value="red">Красный</option>
          <option value="green">Зеленый</option>
          <option value="blue">Синий</option>
        </select>
      </div>
    </div>
    <div class="third">
      <select id="colors-third" class="box-select">
        <option value="" selected disabled hidden>Цвет бренда:</option>
        <option value="red">Красный</option>
        <option value="green">Зеленый</option>
        <option value="blue">Синий</option>
      </select>
    </div>
    <div class="fourth">
      <select id="colors-fourth" class="box-select">
        <option value="" selected disabled hidden>Цвет логотипа:</option>
        <option value="red">Красный</option>
        <option value="green">Зеленый</option>
        <option value="blue">Синий</option>
      </select>
    </div>
    <div class="fifth">
      <select id="colors-fifth" class="box-select">
        <option value="" selected disabled hidden>Цвет знака логотипа:</option>
        <option value="red">Красный</option>
        <option value="green">Зеленый</option>
        <option value="blue">Синий</option>
      </select>
    </div>
  </div>
  <div id="modal" class="modal">
    <div class="modal__content">
      <span class="modal__content--close">&times;</span>
      <p class="modal__content--text">Отсканируйте QR-код с помощью приложения камеры на мобильном устройстве.</p>
      <div class="modal__content--qr" id="qrcode"></div>
    </div>
  </div> 

  
  <script src="components/qrcode.js"></script> 

  <!-- <script src="components/modelComponents/mainColor.js"></script> -->

  <script>
   const modelViewerColor = document.querySelector("model-viewer#color");
const select = document.getElementById('colors-main');
const select1 = document.getElementById('colors-second');

let model; // добавляем переменную для хранения модели

fetch('./get/demo.glb')
  .then(response => response.blob())
  .then(blob => {
    const reader = new FileReader();
    reader.onload = () => {

      model = reader.result; // сохраняем модель в переменной

      modelViewerColor.src = URL.createObjectURL(blob);

      select.addEventListener('change', () => {
        const optionValue = select.value;
        const secValue = select1.value;
        const optionToSelect = Array.from(select.options).find(option => option.value === optionValue);
        const params = new URLSearchParams();

        params.append('optionValue', optionValue);
        params.append('secValue', secValue);

        const url = new URL(window.location.href);
        url.search = params.toString();
        const newUrl = url.toString();
        history.pushState(null, '', newUrl)

        // обновляем модель при изменении параметров
        const [material, kek] = modelViewerColor.model.materials;
        material.pbrMetallicRoughness.setBaseColorFactor(optionValue);
        kek.pbrMetallicRoughness.setBaseColorFactor(secValue);
      })

      modelViewerColor.addEventListener('load', () => {

        const urlParams = new URLSearchParams(window.location.search);
        const optionValue = urlParams.get('optionValue');
        const optionValue1 = urlParams.get('secValue');

        const optionToSelect = Array.from(select.options).find(option => option.value === optionValue);

        if (optionValue) {
          const optionToSelect = select.querySelector(`option[value="${optionValue}"]`);
          const optionToSelect1 = select.querySelector(`option[value="${optionValue1}"]`);

          if (optionToSelect) {
            optionToSelect.selected = true;

            // обновляем модель на основе выбранных параметров
            const [material, kek] = modelViewerColor.model.materials;
            material.pbrMetallicRoughness.setBaseColorFactor(optionValue);
            kek.pbrMetallicRoughness.setBaseColorFactor(optionValue1);
          }
        }
      })
    };

    reader.readAsArrayBuffer(blob);
  });

// генерируем QR-код со ссылкой на страницу с измененной моделью
const qrcode = new QRCode(document.getElementById("qrcode"), {
  text: `${url}#ar`,
  width: 270,
  height: 270,
  colorDark : "#000000",
  colorLight : "#ffffff",
  correctLevel : QRCode.CorrectLevel.H
});
  </script>

<script>
  if (href.endsWith('#ar')) {
    window.addEventListener("load", () => {
        var modelViewer = document.querySelector('.model-viewer');
        console.log("Can activate AR: " + modelViewer.canActivateAR);
        modelViewer.activateAR();
    });
}
</script>



  
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js" defer></script>
  <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.1.3/webcomponents-loader.js" defer></script>
  <script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js" defer></script>
  <script src="https://unpkg.com/resize-observer-polyfill@1.5.0/dist/ResizeObserver.js" defer></script>
  <script src="https://unpkg.com/fullscreen-polyfill@1.0.2/dist/fullscreen.polyfill.js" defer></script>
  <script src="https://unpkg.com/@magicleap/prismatic/prismatic.min.js" defer></script>
  <script src="components/focus-visible.js" defer></script>
  <script src="components/yandexMetrika.js" defer></script>
  <script src="components/script.js"></script> -->
</body>
</html>